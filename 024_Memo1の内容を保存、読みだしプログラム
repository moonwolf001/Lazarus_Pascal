// Lazarusのファイル操作例
//プログラムの仕様：
// [1] Form1上に、Memo1、Button1、Button2がある。
// [2] このプログラムはData01.txtというテキストファイルを操作する。場所はカレントディレクトリー（ .\Data01.txt ）
// [3] テキストファイルが既に存在する場合、フォーム立ち上げ時にそのテキストファイルの内容をForm1に表示。
// [4] Memo1にテキスト内容を書き込み、Button2を押すとファイルが無ければファイルを作成しながら書き込み。ファイルが存在すれば、ファイルの内容をMemo1内容で上書き。
// [5] フォーム作成時以外でも、Button1を押すとファイル内容をMemo1に表示。

unit Unit1;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, Forms, Controls, StdCtrls, Dialogs;

type

  { TForm1 }

  TForm1 = class(TForm)
    Button1: TButton; // ファイル読み込み
    Button2: TButton; // ファイル書き込み
    Memo1: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private

  public

  end;

var
  Form1: TForm1;

implementation

{$R *.lfm}

// ファイル読み込み共通処理
procedure LoadFile;
var
  F: TextFile;  // テキストファイル型変数
  Line: string;
begin
  // 相対パスでファイルを読み込む
  if FileExists('.\Data01.txt') then
  begin
    AssignFile(F, '.\Data01.txt');  // ファイルをFに関連付け
    Reset(F);  // 読み取りモードでファイルを開く
    Form1.Memo1.Lines.Clear;  // Memoの内容をクリア

    try
      while not EOF(F) do
      begin
        ReadLn(F, Line);  // 1行ずつ読み込む
        Form1.Memo1.Lines.Add(Line);  // 読み込んだ行をMemoに追加
      end;
    finally
      CloseFile(F);  // ファイルを閉じる
    end;
  end;
end;

// アプリ起動時にファイルを読み込む
procedure TForm1.FormCreate(Sender: TObject);
begin
  LoadFile;  // 起動時にファイルを読み込む
  Button1.Caption:= 'Button1 ファイルの読み込み';
  Button2.Caption:= 'Button2 ファイルへの書き込み';
end;

//  ボタン1クリック時にファイルを再読み込み
procedure TForm1.Button1Click(Sender: TObject);
begin
  LoadFile;  // ボタン1クリックでファイルを読み込む
end;

//  ボタン2クリック時にファイルを書き込む
procedure TForm1.Button2Click(Sender: TObject);
var
  F: TextFile;  // テキストファイル型変数
  i: Integer;
begin
  // ファイル作成確認メッセージ
  if MessageDlg('ファイルを作成、または上書きしても良いですか？',
        mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin
    AssignFile(F, '.\Data01.txt');
    Rewrite(F);  // 新規作成または上書きモードでファイルを開く

    try
      // Memo1の内容を行ごとにファイルに書き込む
      for i := 0 to Memo1.Lines.Count - 1 do
      begin
        WriteLn(F, Memo1.Lines[i]);
      end;
    finally
      CloseFile(F);  // ファイルを閉じる
    end;
  end;
end;

end.
